apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  creationTimestamp: null
  labels:
    app: prometheus-operator
    prometheus: general-project-alerts
    release: prometheus-operator
    role: general-project-alert-rules
  name: general-project-alerts
  namespace: monitoring
spec:
  groups:
  - name: containers.rules
    rules:
    - alert: ManyContainerRestarts
      expr: sum by(container, pod, namespace) (kube_pod_container_status_restarts_total - kube_pod_container_status_restarts_total offset 8h > 10)
      for: 2m
      labels:
        scope: project
        severity: testing_major
      annotations:
        message: Container {{ $labels.namespace }}/{{ $labels.pod }}/{{ $labels.container }} restarted {{ $value }} times in the last 8 hours.
    - alert: ContainerWaiting
      expr: sum by (container, pod, namespace, reason) (avg_over_time(kube_pod_container_status_waiting_reason{reason!="CrashLoopBackOff"}[15m:])) > 0.8
      for: 1h
      labels:
        scope: project
        severity: testing_major
      annotations:
        message: Container {{ $labels.namespace }}/{{ $labels.pod }}/{{ $labels.container }} has been in {{ $labels.reason }} for over an hour.
  - name: pods.rules
    rules:
    - alert: PodNotReady
      expr: sum by(namespace, pod) (max by(namespace, pod) (kube_pod_status_phase{job="kube-state-metrics",namespace=~".*",phase=~"Pending|Unknown"}) * on(namespace, pod) group_left(owner_kind) topk by(namespace, pod) (1, max by(namespace, pod, owner_kind) (kube_pod_owner{owner_kind!="Job"}))) > 0
      for: 15m
      labels:
        scope: project
        severity: testing_major
      annotations:
        message: Pod {{ $labels.namespace }}/{{ $labels.pod }} has been in a non-ready state for longer than 15 minutes.
