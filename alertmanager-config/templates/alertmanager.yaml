#alertmanager configuration secret
#To-do: Pipeline this
global:
  resolve_timeout: 5m
  smtp_smarthost: {{ .Values.smtp_smarthost | squote }}
  smtp_from: {{ .Values.smtp_from | squote }}
  smtp_auth_username: {{ .Values.smtp_auth_username | squote }}
  smtp_auth_identity: {{ .Values.smtp_auth_username | squote }}
  smtp_auth_password: {{ .Values.smtp_auth_password | squote }}
  smtp_require_tls: true
receivers:
- name: email
  email_configs:
  - to: {{ .Values.email_to | squote }}
    send_resolved: true
    html: {{`'{{ template "email.email.html" . }}'`}}
- name: email_no_resolve
  email_configs:
  - to: {{ .Values.email_to | squote }}
    send_resolved: false
    html: {{`'{{ template "email.email.html" . }}'`}}
- name: test_email
  email_configs:
  - to: {{ .Values.test_email_to | squote }}
    send_resolved: true
    html: {{`'{{ template "email.email.html" . }}'`}}
- name: test_email_no_resolve
  email_configs:
  - to: {{ .Values.test_email_to | squote }}
    send_resolved: false
    html: {{`'{{ template "email.email.html" . }}'`}}
- name: cloud_slack
  slack_configs: 
  - api_url: {{ .Values.cloud_slack_incoming_webhook | squote }}
    channel: '#prometheus-alerts'
    send_resolved: true
    color: {{`'{{ template "slack.slackcustom.color" . }}'`}}
    title: {{`'{{ template "slack.slackcustom.title" . }}'`}}
    text: {{`'{{ template "slack.slackcustom.text" . }}'`}}
- name: cloud_slack_no_resolve
  slack_configs: 
  - api_url: {{ .Values.cloud_slack_incoming_webhook | squote }}
    channel: '#prometheus-alerts'
    send_resolved: false
    color: {{`'{{ template "slack.slackcustom.color" . }}'`}}
    title: {{`'{{ template "slack.slackcustom.title" . }}'`}}
    text: {{`'{{ template "slack.slackcustom.text" . }}'`}}
- name: test_slack
  slack_configs: 
  - api_url: {{ .Values.test_slack_incoming_webhook | squote }}
    channel: '#resolve'
    send_resolved: true
    color: {{`'{{ template "slack.slackcustom.color" . }}'`}}
    title: {{`'{{ template "slack.slackcustom.title" . }}'`}}
    text: {{`'{{ template "slack.slackcustom.text" . }}'`}}
- name: test_slack_no_resolve
  slack_configs: 
  - api_url: {{ .Values.test_slack_no_resolve_incoming_webhook | squote }}
    channel: '#no-resolve'
    send_resolved: false
    color: {{`'{{ template "slack.slackcustom.color" . }}'`}}
    title: {{`'{{ template "slack.slackcustom.title" . }}'`}}
    text: {{`'{{ template "slack.slackcustom.text" . }}'`}}
- name: black_hole #Empty default receiver
route:
  ### MEMO: For multi-cluster AlertManager, group by 'cluster' too
  group_by: ['cluster', 'alertname', 'namespace']
  group_interval: 10m
  group_wait: 2m
  # repeat_interval cannot be greater than alertmanagerSpec retention
  repeat_interval: 1w
  receiver: black_hole
  routes:
  ### PLATFORM-WIDE ALERTS
  - match_re:
      scope: platform
    receiver: black_hole
    routes:
    - match_re:
        severity: major|urgent
      receiver: cloud_slack
      routes:
      - match_re:
          resolves: never
        receiver: cloud_slack_no_resolve
      continue: true
    - match_re:
        severity: urgent
      receiver: email
      routes:
      - match_re:
          resolves: never
        receiver: email_no_resolve
    - match_re:
        severity: testing_major|testing_urgent
      receiver: test_slack
      routes:
      - match_re:
          resolves: never
        receiver: test_slack_no_resolve
      continue: true
    - match_re:
        severity: testing_urgent
      receiver: test_email
      routes:
      - match_re:
          resolves: never
        receiver: test_email_no_resolve
  ### PLATFORM PROJECT-SPECIFIC ALERTS
  - match_re:
      scope: project
      namespace: cert-manager|ci|cloudops|default|elastic-system|gatekeeper-system|istio-operator|istio-system|kube-node-lease|kube-public|kube-system|kubecost|logging|monitoring|starboard|starboard-operator|twistlock|velero
    receiver: black_hole
    routes:
    - match_re:
        severity: major|urgent
      receiver: cloud_slack
      routes:
      - match_re:
          resolves: never
        receiver: cloud_slack_no_resolve
      continue: true
    - match_re:
        severity: urgent
      receiver: email
      routes:
      - match_re:
          resolves: never
        receiver: email_no_resolve
    - match_re:
        severity: testing_major|testing_urgent
      receiver: test_slack
      routes:
      - match_re:
          resolves: never
        receiver: test_slack_no_resolve
      continue: true
    - match_re:
        severity: testing_urgent
      receiver: test_email
      routes:
      - match_re:
          resolves: never
        receiver: test_email_no_resolve
inhibit_rules:
  # Don't alert generic NodeNotReady when there is a known cause
  - target_match:
      alertname: 'NodeNotReady'
    source_match_re:
      alertname: '(NodeDiskPressure|NodeMemoryPressure|NodePIDPressure|NodeMemoryPressure|NodeNetworkUnavailable)'
    equal: ['cluster', 'node']
  - target_match:
      alertname: 'NodeLowPodCapacity'
    source_match:
      alertname: 'NodePodsFull'
    equal: ['cluster', 'node']
  - target_match:
      alertname: 'NodepoolLowPodCapacity'
    source_match:
      alertname: 'NodepoolPodsFull'
    equal: ['cluster', 'label_agentpool']
  - target_match:
      alertname: 'ManyAlertsFiring'
    source_match:
      alertname: 'ManyManyAlertsFiring'
    equal: ['cluster', 'alertfiring', 'namespace']
  - target_match:
      alertname: 'VeleroBackupFailure'
    source_match_re:
      alertname: '(ContinuousVeleroBackupFailure|VeleroHourlyBackupFailure)'
    equal: ['cluster', 'schedule']
  - target_match:
      alertname: 'VeleroBackupPartialFailure'
    source_match_re:
      alertname: '(ContinuousVeleroBackupPartialFailure|VeleroHourlyBackupPartialFailure)'
    equal: ['cluster', 'schedule']
  - target_match:
      alertname: 'JobFailed'
    source_match:
      alertname: 'BackupJobFailed'
    equal: ['cluster', 'job_name']

templates:
- '*.tmpl'
- '*.html'
